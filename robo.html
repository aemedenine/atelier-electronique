<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robo V6 - Atelier Ã‰lectronique MÃ©denine ğŸ¤–</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <!-- Puter.js Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Grok (Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ù…Ø·ÙˆØ±) -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1 { margin: 15px 0; text-shadow: 0 0 10px #0ff; text-align: center; }
    #robo-v6-container { max-width: 420px; width: 100%; padding: 10px; }
    model-viewer#robo-v6 {
      width: 260px; height: 260px; border-radius: 50%;
      box-shadow: 0 0 50px rgba(255,165,0,0.6);
      margin: 0 auto 20px; display: block;
      transition: transform 0.4s ease;
    }
    #chat-area {
      background: rgba(0,0,0,0.65); padding: 20px; border-radius: 16px;
      min-height: 180px; text-align: center; position: relative;
    }
    .message {
      margin: 5px 5px; padding: 8px 8px; border-radius: 22px;
      max-width: 90%; word-wrap: break-word; font-size: 1em;
      opacity: 0; transition: opacity 0.5s ease;
    }
    .user { background: #1e8449; }
    .bot { background: rgba(255,165,0,0.35); }
    .typing { font-style: italic; color: #aaa; opacity: 1; margin: 15px 0; }
    .input-area { display: flex; margin-top: 15px; }
    .input-area input {
      flex: 1; padding: 14px 16px; border-radius: 30px 0 0 30px;
      border: none; outline: none; font-size: 1em;
    }
    .input-area button:hover { background: #e69500; }
    #upload-image { margin: 12px 0; display: none; width: 100%; }
    .whatsapp-btn {
      display: none; margin: 15px auto; padding: 12px 24px;
      background: #25D366; color: white; border-radius: 30px;
      text-decoration: none; font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ¤–ÙˆØ±Ø´Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠ</h1>
  
  <div id="robo-v6-container">
    <model-viewer id="robo-v6" src="robo.glb"
                  alt="Robo Tounsi 3D" auto-rotate camera-controls
                  shadow-intensity="1" rotation-per-second="32deg">
    </model-viewer>

    <div id="chat-area">
      <div id="current-msg" class="message bot">
        Ahla ÙŠØ§ Ø®ÙˆÙŠØ§! Ana Robo v6 Ù…Ù† ÙˆØ±Ø´Ø© Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠ.<br>Ø´Ù†Ùˆ Ù†Ø­Ø¨ Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠÙ‡ Ø§Ù„ÙŠÙˆÙ…ØŸ (ØªØµÙ„ÙŠØ­ØŒ Ø­Ø¬Ø²ØŒ Ø´ÙŠÙ…Ø©ØŒ ÙƒÙˆØ±Ø³...) ğŸš€
      </div>
      <div id="typing-indicator" class="typing" style="display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...</div>
    </div>

    <div class="input-area">
      <input id="robo-input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." autofocus />
      <button onclick="sendRoboMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <input id="upload-image" type="file" accept="image/*" onchange="handleImageUpload()" />
    <a href="#" id="whatsapp-link" class="whatsapp-btn" target="_blank">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCtbEWdm7CAC25ROslGlVeLOvfxdi2exVo",
      authDomain: "atelier-electronique-mednine.firebaseapp.com",
      projectId: "atelier-electronique-mednine",
      storageBucket: "atelier-electronique-mednine.firebasestorage.app",
      messagingSenderId: "547430908384",
      appId: "1:547430908384:web:4caa4cf3869491bd14eb85",
      databaseURL: "https://atelier-electronique-mednine-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Elements
    const roboV6 = document.getElementById('robo-v6');
    const currentMsg = document.getElementById('current-msg');
    const typingIndicator = document.getElementById('typing-indicator');
    const input = document.getElementById('robo-input');
    const uploadInput = document.getElementById('upload-image');
    const whatsappLink = document.getElementById('whatsapp-link');

    let userPhone = null;
    let currentRequest = { type: null, description: '', step: 0 };

    function showTyping() {
      typingIndicator.style.display = 'block';
      currentMsg.style.opacity = '0.4';
    }

    function hideTyping() {
      typingIndicator.style.display = 'none';
      currentMsg.style.opacity = '1';
    }

    function updateMsg(text, type = 'bot') {
      currentMsg.textContent = text;
      currentMsg.className = `message ${type}`;
      currentMsg.style.opacity = '0';
      setTimeout(() => { currentMsg.style.opacity = '1'; }, 300);

      if (type === 'bot') {
        roboV6.style.transform = 'scale(1.12)';
        setTimeout(() => roboV6.style.transform = 'scale(1)', 600);
      }
    }

    function showUpload() {
      uploadInput.style.display = 'block';
    }

    function showWhatsApp(preText = '') {
      const msg = currentRequest.description || input.value.trim() || 'Ø·Ù„Ø¨ ØªØµÙ„ÙŠØ­';
      const waText = preText + encodeURIComponent(msg);
      whatsappLink.href = `https://wa.me/21698192103?text=${waText}`;
      whatsappLink.style.display = 'inline-block';
    }

    function resetRequest() {
      currentRequest = { type: null, description: '', step: 0 };
      uploadInput.style.display = 'none';
    }

    async function sendRoboMsg() {
      const text = input.value.trim();
      if (!text) return;

      // Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ¶ÙˆØ­
      updateMsg(text, 'user');
      input.value = '';

      showTyping();

      // ØªØ£Ø®ÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
      await new Promise(r => setTimeout(r, 1200));

      let reply = 'Ø¢Ø³Ù... Ù…Ø§ ÙÙ‡Ù…ØªØ´ Ù…Ù„ÙŠØ­ ğŸ˜… Ù‚Ù„Ù‘ÙŠ Ø´Ù†Ùˆ Ø¨Ø§Ù„Ø¶Ø¨Ø·';

      const lower = text.toLowerCase();

      if (lower.includes('Ø­Ø¬Ø²') || lower.includes('Ù…ÙˆØ¹Ø¯')) {
        currentRequest.type = 'booking';
        currentRequest.step = 1;
        reply = 'ØªÙ…Ø§Ù…! Ù‚Ù„Ù‘ÙŠ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù„ÙŠ ØªÙ†Ø§Ø³Ø¨Ùƒ + Ø´Ù†Ùˆ Ø§Ù„Ù…Ø´ÙƒÙ„ + Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ';
      } else if (currentRequest.type === 'booking') {
        currentRequest.description = text;
        try {
          await db.ref('bookings').push({
            phone: userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            details: text,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'pending'
          });
          reply = 'Ø­Ø¬Ø²Ùƒ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡! Ù†ØªØµÙ„ Ø¨ÙŠÙƒ Ù‚Ø±ÙŠØ¨ ğŸš€';
          resetRequest();
        } catch (e) {
          reply = 'Ù…Ø´ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§ØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© 98 192 103';
        }
      } else if (lower.includes('ØªØµÙ„ÙŠØ­') || lower.includes('ÙƒØ±Øª') || lower.includes('Ø¨ÙˆØ±Ø¯Ø©')) {
        currentRequest.type = 'repair';
        currentRequest.step = 1;
        reply = 'Ø§Ù‡Ù„Ø§! Ø´Ù†Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ (ØºØ³Ø§Ù„Ø©ØŒ ÙƒÙ„ÙŠÙ…Ø§ØŒ Ù„Ø­Ø§Ù…...) ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„ + Ø±Ù‚Ù…Ùƒ Ø¥Ø°Ø§ ØªØ­Ø¨';
        showUpload();
      } else if (currentRequest.type === 'repair' && currentRequest.step === 1) {
        currentRequest.description = text;
        currentRequest.step = 2;
        reply = 'Ø´ÙƒØ±Ù‹Ø§! Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ±Øª Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙƒØŒ ÙˆØ¥Ù„Ø§ Ù†ÙƒÙ…Ù„ Ø¨Ø¯ÙˆÙ†.';
        showUpload();
      } else if (lower.includes('Ø´ÙŠÙ…Ø©') || lower.includes('schÃ©ma')) {
        reply = 'Ø¹Ø·ÙŠÙ†ÙŠ Ø§Ù„Ù…Ø§Ø±ÙƒØ© ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Ù…Ø«Ø§Ù„: Samsung WW80)ØŒ Ù†Ø¨Ø­Ø«Ù„Ùƒ Ø§Ù„Ø´ÙŠÙ…Ø©.';
        showWhatsApp('Ø´ÙŠÙ…Ø© Ù„Ù€ ');
      } else if (lower.includes('ÙƒÙˆØ±Ø³') || lower.includes('Ø§Ø±Ø¯ÙˆÙŠÙ†Ùˆ') || lower.includes('cours')) {
        reply = 'ØªØ­Ø¨ ÙƒÙˆØ±Ø³ Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ ÙˆÙ„Ø§ Ù…Ø´Ø±ÙˆØ¹ Ø£Ø±Ø¯ÙˆÙŠÙ†ÙˆØŸ Ù‚Ù„Ù‘ÙŠ ÙˆÙ†Ø¨Ø¯Ø£.';
      } else if (lower.includes('ÙˆÙŠÙ†ÙƒÙ…') || lower.includes('Ø¹Ù†ÙˆØ§Ù†') || lower.includes('location')) {
        reply = 'Ù…Ø¯Ù†ÙŠÙ† â€“ Ù†Ù‡Ø¬ Ù„ÙŠØ¨ÙŠØ§ØŒ Ø¨Ø¹Ø¯ ÙƒÙˆØ´Ø© Ø´Ø§Ù…Ø®ØŒ Ø£ÙˆÙ„ Ø·Ù„Ø¹Ø© ÙŠÙ…ÙŠÙ†. Ø±Ù‚Ù…: 98 192 103';
      } else if (/\d{8}/.test(text)) {
        userPhone = text.match(/\d{8}/)[0];
        reply = `Ø´ÙƒØ±Ù‹Ø§ØŒ Ø­ÙØ¸Øª Ø±Ù‚Ù…Ùƒ ${userPhone}. Ø´Ù†Ùˆ Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙÙŠÙ‡ ØªØ§ÙˆØ§ØŸ`;
      } else {
        // Grok Ø¹Ø¨Ø± Puter.js (Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¹Ù‚Ø¯)
        try {
          const grokResponse = await puter.ai.chat([
            { role: 'system', content: 'Ø¬Ø§ÙˆØ¨ Ø¨Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ© Ø²ÙŠ ØµØ¯ÙŠÙ‚ Ø®Ø¨ÙŠØ± ÙÙŠ ØªØµÙ„ÙŠØ­ ÙƒØ±ÙˆØª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (ØºØ³Ø§Ù„Ø§ØªØŒ ÙƒÙ„ÙŠÙ…Ø§ØŒ Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ù„Ø­Ø§Ù…ØŒ Ù…ÙˆØ§Ø²ÙŠÙ†...). ÙƒÙ† Ù…Ø±Ø­ØŒ Ù…ÙÙŠØ¯ ÙˆÙ…Ø¨Ø§Ø´Ø±.' },
            { role: 'user', content: text }
          ], { model: 'x-ai/grok-4-1-fast' });

          reply = grokResponse.message.content || 'Ù…Ø¹Ù„ÙŠØ´... Ù…Ø§ Ù†Ø¬Ø­ØªØ´ØŒ Ø¬Ø±Ø¨ Ø³Ø¤Ø§Ù„ Ø£ÙˆØ¶Ø­ ğŸ˜…';
        } catch (err) {
          reply = 'Ù…Ø´ÙƒÙ„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Grok... Ù‚Ù„Ù‘ÙŠ Ø´Ù†Ùˆ Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙˆÙ†Ø­Ø§ÙˆÙ„ Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙŠØ¯ÙˆÙŠÙ‹Ø§';
          console.error(err);
        }
      }

      hideTyping();
      updateMsg(reply, 'bot');
    }

    async function handleImageUpload() {
      const file = uploadInput.files[0];
      if (!file) return;

      updateMsg('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'bot');
      showTyping();

      const fileName = Date.now() + '_' + file.name;
      const storageRef = storage.ref('repair_images/' + fileName);

      try {
        const snapshot = await storageRef.put(file);
        const url = await snapshot.ref.getDownloadURL();

        await db.ref('repair_requests').push({
          phone: userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          description: currentRequest.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ',
          imageUrl: url,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          status: 'new'
        });

        hideTyping();
        updateMsg('Ø§Ù„ØµÙˆØ±Ø© ÙˆØµÙ„Øª ÙˆØ§Ù„Ø·Ù„Ø¨ Ù…Ø³Ø¬Ù‘Ù„! Ù†ØªØµÙ„ Ø¨ÙŠÙƒ Ù‚Ø±ÙŠØ¨ Ù„Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ø³Ø¹Ø± ğŸ˜', 'bot');
        showWhatsApp('Ø¹Ù†Ø¯ÙŠ Ø·Ù„Ø¨ ØªØµÙ„ÙŠØ­ Ù…Ø¹ ØµÙˆØ±Ø©: ');
        resetRequest();
      } catch (err) {
        hideTyping();
        updateMsg('Ù…Ø´ÙƒÙ„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©... Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø£Ø±Ø³Ù„Ù‡Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨', 'bot');
      }
      uploadInput.value = '';
    }

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendRoboMsg();
    });

    roboV6.addEventListener('pointerenter', () => roboV6.style.transform = 'scale(1.08)');
    roboV6.addEventListener('pointerleave', () => roboV6.style.transform = 'scale(1)');
  </script>
</body>
</html>
