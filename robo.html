<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robo V6 - Atelier Ã‰lectronique MÃ©denine ðŸ¤–</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <!-- Puter.js Ù„Ù€ Grok Ù…Ø¬Ø§Ù†ÙŠ -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1 { margin: 15px 0; text-shadow: 0 0 10px #0ff; }
    #robo-v6-container { max-width: 420px; width: 100%; padding: 10px; }
    model-viewer#robo-v6 {
      width: 260px; height: 260px; border-radius: 50%;
      box-shadow: 0 0 50px rgba(255,165,0,0.6);
      background: rgba(255,255,255,0.05);
      transition: all 0.4s ease; cursor: pointer;
      margin: 0 auto; display: block;
    }
    #chat-area {
      background: rgba(0,0,0,0.6); padding: 20px; border-radius: 16px;
      margin-top: 20px; min-height: 140px; text-align: center;
    }
    .message {
      margin: 0 auto; padding: 14px 18px; border-radius: 22px;
      max-width: 90%; word-wrap: break-word; font-size: 1em;
      transition: opacity 0.4s;
    }
    .user { background: #1e8449; }
    .bot { background: rgba(255,165,0,0.3); }
    .input-area { display: flex; margin-top: 15px; }
    .input-area input {
      flex: 1; padding: 14px 16px; border-radius: 30px 0 0 30px;
      border: none; outline: none;
    }
    .input-area button {
      padding: 14px 24px; border-radius: 0 30px 30px 0;
      background: #ffa500; color: white; border: none;
      cursor: pointer; font-weight: bold;
    }
    #upload-image { margin: 10px 0; display: none; width: 100%; }
    .whatsapp-btn {
      display: none; margin: 12px auto; padding: 12px 24px;
      background: #25D366; color: white; border-radius: 30px;
      text-decoration: none; font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Robo V6 ðŸ¤– - ÙˆØ±Ø´Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠ</h1>
  
  <div id="robo-v6-container">
    <model-viewer id="robo-v6" src="robo.glb" alt="Robo Tounsi 3D"
                  auto-rotate camera-controls shadow-intensity="1"
                  rotation-per-second="32deg"></model-viewer>

    <div id="chat-area">
      <div id="current-msg" class="message bot">
        Ahla ÙŠØ§ Ø®ÙˆÙŠØ§! Ana Robo V6. Ù‚Ù„Ù‘ÙŠ Ø´Ù†Ùˆ ØªØ­Ø¨: ØªØµÙ„ÙŠØ­ ÙƒØ±ØªØŸ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ØŸ Ø´ÙŠÙ…Ø©ØŸ ÙƒÙˆØ±Ø³ØŸ ðŸš€
      </div>
    </div>

    <div class="input-area">
      <input id="robo-input" type="text" placeholder="S2el Robo..." autofocus />
      <button onclick="sendRoboMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <input id="upload-image" type="file" accept="image/*" onchange="handleImageUpload()" />
    <a href="#" id="whatsapp-link" class="whatsapp-btn" target="_blank">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCtbEWdm7CAC25ROslGlVeLOvfxdi2exVo",
      authDomain: "atelier-electronique-mednine.firebaseapp.com",
      projectId: "atelier-electronique-mednine",
      storageBucket: "atelier-electronique-mednine.firebasestorage.app",
      messagingSenderId: "547430908384",
      appId: "1:547430908384:web:4caa4cf3869491bd14eb85",
      databaseURL: "https://atelier-electronique-mednine-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Elements
    const roboV6 = document.getElementById('robo-v6');
    const currentMsg = document.getElementById('current-msg');
    const input = document.getElementById('robo-input');
    const uploadInput = document.getElementById('upload-image');
    const whatsappLink = document.getElementById('whatsapp-link');

    let userPhone = null;
    let currentRequest = { type: null, description: '', step: 0 };

    function updateMsg(text, type = 'bot') {
      currentMsg.textContent = text;
      currentMsg.className = `message ${type}`;
      currentMsg.style.opacity = '0';
      setTimeout(() => { currentMsg.style.opacity = '1'; }, 200);

      if (type === 'bot') {
        roboV6.style.transform = 'scale(1.12)';
        setTimeout(() => roboV6.style.transform = 'scale(1)', 600);
      }
    }

    function showUpload() { uploadInput.style.display = 'block'; }
    function showWhatsApp(preText = '') {
      const msg = currentRequest.description || input.value.trim() || 'Ø·Ù„Ø¨ ØªØµÙ„ÙŠØ­';
      whatsappLink.href = `https://wa.me/21698192103?text=${encodeURIComponent(preText + msg)}`;
      whatsappLink.style.display = 'inline-block';
    }
    function resetRequest() {
      currentRequest = { type: null, description: '', step: 0 };
      uploadInput.style.display = 'none';
    }

    async function sendRoboMsg() {
      const text = input.value.trim();
      if (!text) return;

      updateMsg(text, 'user');
      input.value = '';

      let reply = 'Ø¢Ø³Ù... Ù…Ø§ ÙÙ‡Ù…ØªØ´ Ù…Ù„ÙŠØ­ ðŸ˜… Ù‚Ù„Ù‘ÙŠ Ø´Ù†Ùˆ Ø¨Ø§Ù„Ø¶Ø¨Ø·';

      const lower = text.toLowerCase();

      if (lower.includes('Ø­Ø¬Ø²') || lower.includes('Ù…ÙˆØ¹Ø¯')) {
        currentRequest.type = 'booking';
        currentRequest.step = 1;
        reply = 'ØªÙ…Ø§Ù…! Ù‚Ù„Ù‘ÙŠ: Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø³Ø§Ø¹Ø© + Ø´Ù†Ùˆ Ø§Ù„Ù…Ø´ÙƒÙ„ + Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ';
      } else if (currentRequest.type === 'booking') {
        currentRequest.description = text;
        try {
          await db.ref('bookings').push({
            phone: userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            details: text,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'pending'
          });
          reply = 'Ø­Ø¬Ø²Ùƒ Ù…Ø³Ø¬Ù‘Ù„! Ù†ØªØµÙ„ Ø¨ÙŠÙƒ Ù‚Ø±ÙŠØ¨ ðŸš€';
          resetRequest();
        } catch (e) {
          reply = 'Ù…Ø´ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§ØªØµÙ„ 98 192 103';
        }
      } else if (lower.includes('ØªØµÙ„ÙŠØ­') || lower.includes('ÙƒØ±Øª') || lower.includes('Ø¨ÙˆØ±Ø¯Ø©')) {
        currentRequest.type = 'repair';
        currentRequest.step = 1;
        reply = 'Ø§Ù‡Ù„Ø§! Ø´Ù†Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² (ØºØ³Ø§Ù„Ø©ØŒ ÙƒÙ„ÙŠÙ…Ø§...ØŸ) ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„ + Ø±Ù‚Ù…Ùƒ Ø¥Ø°Ø§ ØªØ­Ø¨';
        showUpload();
      } else if (currentRequest.type === 'repair' && currentRequest.step === 1) {
        currentRequest.description = text;
        currentRequest.step = 2;
        reply = 'Ø´ÙƒØ±Ù‹Ø§! Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ±Øª Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙƒØŒ ÙˆØ¥Ù„Ø§ Ù†ÙƒÙ…Ù„';
        showUpload();
      } else if (lower.includes('Ø´ÙŠÙ…Ø©') || lower.includes('schÃ©ma')) {
        reply = 'Ù‚Ù„Ù‘ÙŠ Ø§Ù„Ù…Ø§Ø±ÙƒØ© ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Ù…Ø«Ø§Ù„: LG ØºØ³Ø§Ù„Ø©)ØŒ Ù†Ø¨Ø­Ø«Ù„Ùƒ Ø§Ù„Ø´ÙŠÙ…Ø©';
        showWhatsApp('Ø´ÙŠÙ…Ø© Ù„Ù€ ');
      } else if (lower.includes('ÙƒÙˆØ±Ø³') || lower.includes('Ø§Ø±Ø¯ÙˆÙŠÙ†Ùˆ')) {
        reply = 'ØªØ­Ø¨ ÙƒÙˆØ±Ø³ Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆÙ„Ø§ Ù…Ø´Ø±ÙˆØ¹ Ø£Ø±Ø¯ÙˆÙŠÙ†ÙˆØŸ Ù‚Ù„Ù‘ÙŠ';
      } else if (lower.includes('ÙˆÙŠÙ†ÙƒÙ…') || lower.includes('Ø¹Ù†ÙˆØ§Ù†')) {
        reply = 'Ù…Ø¯Ù†ÙŠÙ† â€“ Ù†Ù‡Ø¬ Ù„ÙŠØ¨ÙŠØ§ØŒ Ø¨Ø¹Ø¯ ÙƒÙˆØ´Ø© Ø´Ø§Ù…Ø®ØŒ Ø£ÙˆÙ„ Ø·Ù„Ø¹Ø© ÙŠÙ…ÙŠÙ†. 98 192 103';
      } else if (/\d{8}/.test(text)) {
        userPhone = text.match(/\d{8}/)[0];
        reply = `Ø±Ù‚Ù…Ùƒ ${userPhone} Ù…Ø­ÙÙˆØ¸. Ø´Ù†Ùˆ Ù†Ø­Ø¨ Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠÙ‡ØŸ`;
      } else {
        // Grok fallback (Ù…Ø¬Ø§Ù†ÙŠ via Puter.js)
        try {
          updateMsg('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± Ù…Ø¹ Grok... â³', 'bot');
          const grokResponse = await puter.ai.chat([
            { role: 'system', content: 'Ø¬Ø§ÙˆØ¨ Ø¨Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ© Ø²ÙŠ ØµØ¯ÙŠÙ‚ Ø®Ø¨ÙŠØ± ÙÙŠ ØªØµÙ„ÙŠØ­ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ (ØºØ³Ø§Ù„Ø§ØªØŒ ÙƒÙ„ÙŠÙ…Ø§ØŒ Ù„Ø­Ø§Ù…...). ÙƒÙ† Ù…ÙÙŠØ¯ØŒ Ù…Ø±Ø­ØŒ Ù…Ø®ØªØµØ±.' },
            { role: 'user', content: text }
          ], { model: 'x-ai/grok-4-1-fast' });  // Ø£Ùˆ grok-3-fast Ø¥Ø°Ø§ Ù…Ø§ Ù…Ø´ÙŠ

          reply = grokResponse.message.content || 'Ù…Ø¹Ù„ÙŠØ´ØŒ Ù…Ø§ Ù†Ø¬Ø­ØªØ´... Ø¬Ø±Ø¨ Ø³Ø¤Ø§Ù„ Ø£ÙˆØ¶Ø­ ðŸ˜…';
        } catch (err) {
          reply = 'Ù…Ø´ÙƒÙ„ ÙÙŠ Grok... Ø¬Ø±Ø¨ Ø³Ø¤Ø§Ù„ Ø¨Ø³ÙŠØ· Ø£Ùˆ Ø§ØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© 98 192 103';
          console.error(err);
        }
      }

      setTimeout(() => updateMsg(reply, 'bot'), 800);
    }

    async function handleImageUpload() {
      const file = uploadInput.files[0];
      if (!file) return;

      updateMsg('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'bot');

      const fileName = Date.now() + '_' + file.name;
      const storageRef = storage.ref('repair_images/' + fileName);

      try {
        const snapshot = await storageRef.put(file);
        const url = await snapshot.ref.getDownloadURL();

        await db.ref('repair_requests').push({
          phone: userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          description: currentRequest.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ',
          imageUrl: url,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          status: 'new'
        });

        updateMsg('Ø§Ù„ØµÙˆØ±Ø© ÙˆØµÙ„Øª ÙˆØ§Ù„Ø·Ù„Ø¨ Ù…Ø³Ø¬Ù‘Ù„! Ù†ØªØµÙ„ Ø¨ÙŠÙƒ Ù‚Ø±ÙŠØ¨ ðŸ˜Ž', 'bot');
        showWhatsApp('Ø·Ù„Ø¨ ØªØµÙ„ÙŠØ­ Ù…Ø¹ ØµÙˆØ±Ø©: ');
        resetRequest();
      } catch (err) {
        updateMsg('Ù…Ø´ÙƒÙ„ ÙÙŠ Ø§Ù„Ø±ÙØ¹... Ø¬Ø±Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨', 'bot');
      }
      uploadInput.value = '';
    }

    input.addEventListener('keypress', e => { if (e.key === 'Enter') sendRoboMsg(); });

    roboV6.addEventListener('pointerenter', () => roboV6.style.transform = 'scale(1.08)');
    roboV6.addEventListener('pointerleave', () => roboV6.style.transform = 'scale(1)');
  </script>
</body>
</html>
