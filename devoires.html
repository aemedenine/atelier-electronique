<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÙØ±ÙˆØ¶ Bac Pro</title>
  <meta name="description" content="Ù…Ù†ØµØ© ÙØ±ÙˆØ¶ ÙˆØ§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ ØªÙˆÙ†Ø³ - Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŒ ØªÙ‚Ù†ÙŠØ©ØŒ Ø¥Ø¹Ù„Ø§Ù…ÙŠØ© ÙˆØºÙŠØ±Ù‡Ø§"/>
  
  <!-- Firebase v10+ modular (Ø£Ø­Ø¯Ø« ÙˆØ£ÙØ¶Ù„) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      // Ø­Ø· Ù‡Ù†Ø§ Ø§Ù„Ù€ config Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ØªØ¨Ø¹Ùƒ (Ù…Ù† Firebase console)
      apiKey: "AIzaSy...your-real-key",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project",
      storageBucket: "your-project.firebasestorage.app",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db; // for dev only â€” remove in production
  </script>

  <style>
    :root {
      --primary: #0066cc;
      --primary-dark: #004080;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #1a1a1a;
      --gray: #6c757d;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    [data-theme="dark"] {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e0e0e0;
      --gray: #a0a0a0;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 2.5rem 1rem;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    #searchBox {
      width: 100%;
      padding: 0.9rem 1.2rem;
      font-size: 1.1rem;
      border: 2px solid #ddd;
      border-radius: var(--radius);
      margin: 1.5rem 0;
      transition: border-color 0.3s;
    }
    #searchBox:focus { border-color: var(--primary); outline: none; }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin: 1.5rem 0;
    }
    .filters select, .filters button {
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
    }
    button#themeToggle {
      background: var(--primary);
      color: white;
      border: none;
    }

    .stats {
      background: #fff3cd;
      color: #664d03;
      padding: 1rem;
      border-radius: var(--radius);
      text-align: center;
      margin: 1rem 0;
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .card {
      background: var(--card);
      padding: 1.8rem;
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: var(--shadow);
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }
    .devoirs-list { display: none; }
    .devoirs-list.active { display: block; }
    .devoir-item {
      background: var(--card);
      margin: 0.8rem 0;
      padding: 1.2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .devoir-item a {
      background: var(--primary);
      color: white;
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.2s;
    }
    .devoir-item a:hover { background: var(--primary-dark); }

    @media (max-width: 600px) {
      .devoir-item { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body data-theme="light">

<header>
  <h1>ğŸ“ ÙØ±ÙˆØ¶ Bac Pro</h1>
  <p>ÙƒÙ„ ÙØ±ÙˆØ¶ Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯ â€“ ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹ ÙˆØªØµÙÙŠØ© Ø°ÙƒÙŠØ©</p>
</header>

<div class="container">
  <input type="text" id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¶ Ù…Ø¹ÙŠÙ† (Ø§Ø³Ù…ØŒ Ø³Ù†Ø©ØŒ Ù…Ø§Ø¯Ø©...) ğŸ”" />

  <div class="filters">
    <select id="filterYear">
      <option value="">Ø§Ù„Ø³Ù†Ø© Ø§Ù„ÙƒÙ„</option>
      <option value="1ere">1Ã¨re</option>
      <option value="2nde">2nde</option>
    </select>
    <select id="filterSubject">
      <option value="">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙƒÙ„</option>
      <option value="maths">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
      <option value="tech">ØªÙ‚Ù†ÙŠØ©</option>
      <option value="info">Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©</option>
      <option value="sciences">Ø¹Ù„ÙˆÙ…</option>
      <option value="eco">Ø§Ù‚ØªØµØ§Ø¯</option>
      <option value="arab">Ø¢Ø¯Ø§Ø¨</option>
    </select>
    <button id="themeToggle">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
  </div>

  <div class="stats" id="mostDownloaded">â­ Ø§Ù„Ø£ÙƒØ«Ø± ØªØ­Ù…ÙŠÙ„Ø§Ù‹: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <div class="grid" id="sectionsGrid">
    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
  </div>

  <!-- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¶ -->
  <div id="tech" class="devoirs-list"></div>
  <div id="maths" class="devoirs-list"></div>
  <div id="info" class="devoirs-list"></div>
  <div id="sciences" class="devoirs-list"></div>
  <div id="eco" class="devoirs-list"></div>
  <div id="arab" class="devoirs-list"></div>
</div>

<script type="module">
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Config & State
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const subjects = ["tech", "maths", "info", "sciences", "eco", "arab"];
  let allDevoirs = [];
  let downloadCounts = {};

  const db = window.db;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Fetch Data from Firestore (Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø©)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadData() {
    try {
      const colRef = collection(db, "devoirs");
      const snapshot = await getDocs(colRef);
      allDevoirs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
      const countsSnap = await getDocs(collection(db, "downloads"));
      countsSnap.forEach(d => {
        downloadCounts[d.id] = d.data().count || 0;
      });

      renderSections();
      updateMostDownloaded();
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
      document.getElementById("mostDownloaded").textContent = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
    }
  }

  function renderSections() {
    const grid = document.getElementById("sectionsGrid");
    grid.innerHTML = subjects.map(sub => `
      <div class="card" data-subject="${sub}" role="button" tabindex="0">
        ${getEmoji(sub)} ${getSubjectName(sub)}
      </div>
    `).join("");

    // events
    document.querySelectorAll(".card").forEach(card => {
      card.addEventListener("click", () => showDevoirs(card.dataset.subject));
      card.addEventListener("keydown", e => { if (e.key === "Enter") showDevoirs(card.dataset.subject); });
    });
  }

  function getEmoji(s) {
    const emojis = { tech:"âš™ï¸", maths:"ğŸ“", info:"ğŸ’»", sciences:"ğŸ§ª", eco:"ğŸ“Š", arab:"ğŸ“–" };
    return emojis[s] || "ğŸ“„";
  }

  function getSubjectName(s) {
    const names = { tech:"ØªÙ‚Ù†ÙŠØ©", maths:"Ø±ÙŠØ§Ø¶ÙŠØ§Øª", info:"Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©", sciences:"Ø¹Ù„ÙˆÙ…", eco:"Ø§Ù‚ØªØµØ§Ø¯", arab:"Ø¢Ø¯Ø§Ø¨" };
    return names[s] || s;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¶
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showDevoirs(subject) {
    document.querySelectorAll('.devoirs-list').forEach(el => el.classList.remove('active'));

    const container = document.getElementById(subject);
    if (!container.dataset.loaded) {
      const filtered = allDevoirs.filter(d => d.subject === subject);

      container.innerHTML = filtered.map(d => {
        const id = d.id;
        const downloads = downloadCounts[id] || 0;
        return `
          <div class="devoir-item" data-year="${d.year}" data-subject="${d.subject}">
            <div>
              <h3>${d.title}</h3>
              <small>Ø§Ù„Ø³Ù†Ø©: ${d.year === "1ere" ? "Ø£ÙˆÙ„Ù‰" : "Ø«Ø§Ù†ÙŠØ©"} | ${getSubjectName(d.subject)}</small>
            </div>
            <a href="${d.file}" target="_blank" rel="noopener noreferrer"
               onclick="incrementDownload('${id}'); return true;">
              ğŸ“¥ ØªØ­Ù…ÙŠÙ„ (${downloads})
            </a>
          </div>
        `;
      }).join("");
      container.dataset.loaded = "true";
    }

    container.classList.add('active');
    filterDevoirs();
  }

  window.incrementDownload = async function(id) {
    downloadCounts[id] = (downloadCounts[id] || 0) + 1;
    updateMostDownloaded();

    try {
      await setDoc(doc(db, "downloads", id), { count: increment(1) }, { merge: true });
    } catch(e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª", e);
    }
  };

  function updateMostDownloaded() {
    if (allDevoirs.length === 0) return;
    const top = allDevoirs
      .map(d => ({ ...d, downloads: downloadCounts[d.id] || 0 }))
      .sort((a,b) => b.downloads - a.downloads)[0];

    document.getElementById("mostDownloaded").textContent =
      `â­ Ø§Ù„Ø£ÙƒØ«Ø± ØªØ­Ù…ÙŠÙ„Ø§Ù‹: ${top.title} (${top.downloads} ØªØ­Ù…ÙŠÙ„)`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Filtre & Search
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function filterDevoirs() {
    const year = document.getElementById("filterYear").value;
    const subj = document.getElementById("filterSubject").value;

    document.querySelectorAll('.devoirs-list.active .devoir-item').forEach(item => {
      const matchYear = !year || item.dataset.year === year;
      const matchSubj = !subj || item.dataset.subject === subj;
      item.style.display = matchYear && matchSubj ? "" : "none";
    });
  }

  let searchTimeout;
  document.getElementById("searchBox").addEventListener("input", e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const val = e.target.value.toLowerCase().trim();
      document.querySelectorAll('.devoirs-list.active .devoir-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(val) ? "" : "none";
      });
    }, 300);
  });

  document.getElementById("filterYear").addEventListener("change", filterDevoirs);
  document.getElementById("filterSubject").addEventListener("change", filterDevoirs);

  // Dark mode
  document.getElementById("themeToggle").addEventListener("click", () => {
    const body = document.body;
    const current = body.dataset.theme;
    body.dataset.theme = current === "dark" ? "light" : "dark";
    localStorage.setItem("theme", body.dataset.theme);
  });

  // Load saved theme
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.dataset.theme = savedTheme;

  // Start
  loadData();
</script>
</body>
</html>
